const chai = require('chai');
const chaiHttp = require('chai-http');
const nock = require('nock');
chai.use(chaiHttp);
const { iexApiKey } = require('./envconfig');
const { getStock } = require('./getStock');
const expect = chai.expect;

const mockPathEvent = {
  resource: '/{stock}',
  path: '/MSFT',
  httpMethod: 'GET',
  headers: null,
  multiValueHeaders: null,
  queryStringParameters: null,
  multiValueQueryStringParameters: null,
  pathParameters: { stock: 'MSFT' },
};
const mockBlankEvent = {
  resource: '/{city}',
  path: '/',
  httpMethod: 'GET',
  headers: null,
  multiValueHeaders: null,
  queryStringParameters: null,
  multiValueQueryStringParameters: null,
  pathParameters: null,
};
const mockQueryStringParameters = {
  resource: '/{stock}',
  path: '/',
  httpMethod: 'GET',
  headers: null,
  multiValueHeaders: null,
  queryStringParameters: {
    stock: 'COST',
  },
  multiValueQueryStringParameters: null,
  pathParameters: null,
};

const mockAmznResponse = {
  AMZN: {
    news: [
      {
        datetime: 1594492875000,
        headline:
          "En Alsace - Ils ne veulent pas du projet d'entrepôt d'Amazon",
        source: "L'essentiel",
        url:
          'https://cloud.iexapis.com/v1/news/article/311ba48f-1c19-4eb7-9ce5-189429f749bc',
        summary:
          "BARR - Plusieurs centaines de personnes se sont rassemblées samedi à Barr (Bas-Rhin), pour protester contre un projet d'entrepôt d'Amazon dans une commune voisine.",
        related: 'AMZN',
        image:
          'https://cloud.iexapis.com/v1/news/image/311ba48f-1c19-4eb7-9ce5-189429f749bc',
        lang: 'fr',
        hasPaywall: false,
      },
      {
        datetime: 1594481426000,
        headline:
          'Nicolas de Tavernost : « Nos principaux concurrents ne sont plus les télés françaises »',
        source: "L'Obs",
        url:
          'https://cloud.iexapis.com/v1/news/article/e7d89a6f-8aea-41ff-ab90-364ea7ad8027',
        summary:
          'Netflix, Disney+ ou Amazon vont être tenues de produire des programmes locaux. Mais, selon le PDG de M6, cela ne suffira pas : ces multinationales menacent notre paysage audiovisuel',
        related: 'AMZN',
        image:
          'https://cloud.iexapis.com/v1/news/image/e7d89a6f-8aea-41ff-ab90-364ea7ad8027',
        lang: 'fr',
        hasPaywall: false,
      },
      {
        datetime: 1594480080000,
        headline:
          "JetBlue founder David Neeleman's new airline is pushing back its launch to 2021 – here's what we know about Breeze Airways",
        source: 'Business Insider',
        url:
          'https://cloud.iexapis.com/v1/news/article/e73c71ea-b2dd-4bdb-81a0-3d396618555d',
        summary:
          "David Neeleman's new start-up airline, Breeze Airways, is pushing back its launch to 2021 as the coronavirus pandemic continues to suppress travel. The low-cost airline is Neeleman's fifth, with his most notable in the US being JetBlue Airways, and plans to offer a convenient alternative to the major airlines by flying direct routes between secondary markets. The Airbus A220 will be the flagship aircraft of the fleet making Breeze the third US airline to fly the next-generation Canadian aircraft behind Delta and JetBlue. Visit Business Insider's homepage for more stories . The US will not be gaining another low-cost airline this year as Breeze Airways, the new start-up airline founded by David Neeleman of JetBlue Airways fame, is delaying its launch of operations until 2021. Initially slated for a late-2020 start, the airline's website now welcomes would-be customers with this message: \"Welcome to Breeze Airways, a new airline scheduled for take off in 2021!\" Breeze spokesperson Gareth Edmondson-Jones confirmed the delay due to the coronavirus pandemic to Business Insider on Monday.",
        related: 'AMZN',
        image:
          'https://cloud.iexapis.com/v1/news/image/e73c71ea-b2dd-4bdb-81a0-3d396618555d',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594477708000,
        headline:
          'Amazon says email to employees telling them to delete TikTok was a mistake',
        source: 'The Star',
        url:
          'https://cloud.iexapis.com/v1/news/article/080b789d-c71f-45ab-a2d5-02f67c74d487',
        summary:
          'The company had previously told employees to delete the popular video app from phones on which they use Amazon email, citing “security risks.”',
        related: 'AMZN',
        image:
          'https://cloud.iexapis.com/v1/news/image/080b789d-c71f-45ab-a2d5-02f67c74d487',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594475400000,
        headline:
          'Amazon backtracks on mail sent to employees banning TikTok; claims it was a mistake',
        source: 'Business Today',
        url:
          'https://cloud.iexapis.com/v1/news/article/cc51d9f2-e5ff-455e-9d34-1638c518dec6',
        summary:
          'The initial internal email, which was disseminated widely online, told employees to delete TikTok, a video app increasingly popular with young people but also the focus of intensifying national-security and geopolitical concerns because of its Chinese own',
        related: 'AMZN',
        image:
          'https://cloud.iexapis.com/v1/news/image/cc51d9f2-e5ff-455e-9d34-1638c518dec6',
        lang: 'en',
        hasPaywall: false,
      },
    ],
    quote: {
      symbol: 'AMZN',
      companyName: 'Amazon.com, Inc.',
      primaryExchange: 'NASDAQ',
      calculationPrice: 'close',
      open: 3191.76,
      openTime: 1594387800506,
      openSource: 'official',
      close: 3200,
      closeTime: 1594411200105,
      closeSource: 'official',
      high: 3215,
      highTime: 1594425590825,
      highSource: '15 minute delayed price',
      low: 3135.7,
      lowTime: 1594389868169,
      lowSource: '15 minute delayed price',
      latestPrice: 3200,
      latestSource: 'Close',
      latestTime: 'July 10, 2020',
      latestUpdate: 1594411200105,
      latestVolume: 5485982,
      iexRealtimePrice: null,
      iexRealtimeSize: null,
      iexLastUpdated: null,
      delayedPrice: 3204.47,
      delayedPriceTime: 1594425590825,
      oddLotDelayedPrice: 3200,
      oddLotDelayedPriceTime: 1594411199893,
      extendedPrice: 3204.47,
      extendedChange: 4.47,
      extendedChangePercent: 0.0014,
      extendedPriceTime: 1594425590825,
      previousClose: 3182.63,
      previousVolume: 6388659,
      change: 17.37,
      changePercent: 0.00546,
      volume: 5485982,
      iexMarketPercent: null,
      iexVolume: null,
      avgTotalVolume: 4446075,
      iexBidPrice: null,
      iexBidSize: null,
      iexAskPrice: null,
      iexAskSize: null,
      iexOpen: null,
      iexOpenTime: null,
      iexClose: 3202.72,
      iexCloseTime: 1594411198410,
      marketCap: 1596083200000,
      peRatio: 150.13,
      week52High: 3215,
      week52Low: 1626.03,
      ytdChange: 0.691436,
      lastTradeTime: 1594411200105,
      isUSMarketOpen: false,
    },
    chart: [
      {
        date: '2020-06-11',
        open: 2603.5,
        close: 2557.96,
        high: 2671.38,
        low: 2536.23,
        volume: 5800107,
        uOpen: 2603.5,
        uClose: 2557.96,
        uHigh: 2671.38,
        uLow: 2536.23,
        uVolume: 5800107,
        change: 0,
        changePercent: 0,
        label: 'Jun 11',
        changeOverTime: 0,
      },
      {
        date: '2020-06-12',
        open: 2601.21,
        close: 2545.02,
        high: 2621.48,
        low: 2503.35,
        volume: 5436127,
        uOpen: 2601.21,
        uClose: 2545.02,
        uHigh: 2621.48,
        uLow: 2503.35,
        uVolume: 5436127,
        change: -12.94,
        changePercent: -0.5059,
        label: 'Jun 12',
        changeOverTime: -0.005059,
      },
      {
        date: '2020-06-15',
        open: 2526.6,
        close: 2572.68,
        high: 2584,
        low: 2508,
        volume: 3873335,
        uOpen: 2526.6,
        uClose: 2572.68,
        uHigh: 2584,
        uLow: 2508,
        uVolume: 3873335,
        change: 27.66,
        changePercent: 1.0868,
        label: 'Jun 15',
        changeOverTime: 0.005755,
      },
      {
        date: '2020-06-16',
        open: 2620,
        close: 2615.27,
        high: 2620,
        low: 2576,
        volume: 3595649,
        uOpen: 2620,
        uClose: 2615.27,
        uHigh: 2620,
        uLow: 2576,
        uVolume: 3595649,
        change: 42.59,
        changePercent: 1.6555,
        label: 'Jun 16',
        changeOverTime: 0.022405,
      },
      {
        date: '2020-06-17',
        open: 2647.5,
        close: 2640.98,
        high: 2655,
        low: 2631.82,
        volume: 2959316,
        uOpen: 2647.5,
        uClose: 2640.98,
        uHigh: 2655,
        uLow: 2631.82,
        uVolume: 2959316,
        change: 25.71,
        changePercent: 0.9831,
        label: 'Jun 17',
        changeOverTime: 0.032456,
      },
      {
        date: '2020-06-18',
        open: 2647.01,
        close: 2653.98,
        high: 2659.64,
        low: 2636.11,
        volume: 2487774,
        uOpen: 2647.01,
        uClose: 2653.98,
        uHigh: 2659.64,
        uLow: 2636.11,
        uVolume: 2487774,
        change: 13,
        changePercent: 0.4922,
        label: 'Jun 18',
        changeOverTime: 0.037538,
      },
      {
        date: '2020-06-19',
        open: 2678.08,
        close: 2675.01,
        high: 2697.43,
        low: 2659,
        volume: 5776963,
        uOpen: 2678.08,
        uClose: 2675.01,
        uHigh: 2697.43,
        uLow: 2659,
        uVolume: 5776963,
        change: 21.03,
        changePercent: 0.7924,
        label: 'Jun 19',
        changeOverTime: 0.045759,
      },
      {
        date: '2020-06-22',
        open: 2684.5,
        close: 2713.82,
        high: 2715,
        low: 2669,
        volume: 3208780,
        uOpen: 2684.5,
        uClose: 2713.82,
        uHigh: 2715,
        uLow: 2669,
        uVolume: 3208780,
        change: 38.81,
        changePercent: 1.4508,
        label: 'Jun 22',
        changeOverTime: 0.060931,
      },
      {
        date: '2020-06-23',
        open: 2726.02,
        close: 2764.41,
        high: 2783.11,
        low: 2718.04,
        volume: 4231707,
        uOpen: 2726.02,
        uClose: 2764.41,
        uHigh: 2783.11,
        uLow: 2718.04,
        uVolume: 4231707,
        change: 50.59,
        changePercent: 1.8642,
        label: 'Jun 23',
        changeOverTime: 0.080709,
      },
      {
        date: '2020-06-24',
        open: 2780,
        close: 2734.4,
        high: 2796,
        low: 2721,
        volume: 4526605,
        uOpen: 2780,
        uClose: 2734.4,
        uHigh: 2796,
        uLow: 2721,
        uVolume: 4526605,
        change: -30.01,
        changePercent: -1.0856,
        label: 'Jun 24',
        changeOverTime: 0.068977,
      },
      {
        date: '2020-06-25',
        open: 2739.55,
        close: 2754.58,
        high: 2756.23,
        low: 2712.14,
        volume: 2968657,
        uOpen: 2739.55,
        uClose: 2754.58,
        uHigh: 2756.23,
        uLow: 2712.14,
        uVolume: 2968657,
        change: 20.18,
        changePercent: 0.738,
        label: 'Jun 25',
        changeOverTime: 0.076866,
      },
      {
        date: '2020-06-26',
        open: 2775.06,
        close: 2692.87,
        high: 2782.57,
        low: 2688,
        volume: 6500784,
        uOpen: 2775.06,
        uClose: 2692.87,
        uHigh: 2782.57,
        uLow: 2688,
        uVolume: 6500784,
        change: -61.71,
        changePercent: -2.2403,
        label: 'Jun 26',
        changeOverTime: 0.052741,
      },
      {
        date: '2020-06-29',
        open: 2690.01,
        close: 2680.38,
        high: 2696.8,
        low: 2630.08,
        volume: 4223422,
        uOpen: 2690.01,
        uClose: 2680.38,
        uHigh: 2696.8,
        uLow: 2630.08,
        uVolume: 4223422,
        change: -12.49,
        changePercent: -0.4638,
        label: 'Jun 29',
        changeOverTime: 0.047858,
      },
      {
        date: '2020-06-30',
        open: 2685.07,
        close: 2758.82,
        high: 2769.63,
        low: 2675.03,
        volume: 3769686,
        uOpen: 2685.07,
        uClose: 2758.82,
        uHigh: 2769.63,
        uLow: 2675.03,
        uVolume: 3769686,
        change: 78.44,
        changePercent: 2.9265,
        label: 'Jun 30',
        changeOverTime: 0.078524,
      },
      {
        date: '2020-07-01',
        open: 2757.99,
        close: 2878.7,
        high: 2895,
        low: 2754,
        volume: 6363439,
        uOpen: 2757.99,
        uClose: 2878.7,
        uHigh: 2895,
        uLow: 2754,
        uVolume: 6363439,
        change: 119.88,
        changePercent: 4.3453,
        label: 'Jul 1',
        changeOverTime: 0.125389,
      },
      {
        date: '2020-07-02',
        open: 2912.01,
        close: 2890.3,
        high: 2955.56,
        low: 2871.1,
        volume: 6593387,
        uOpen: 2912.01,
        uClose: 2890.3,
        uHigh: 2955.56,
        uLow: 2871.1,
        uVolume: 6593387,
        change: 11.6,
        changePercent: 0.403,
        label: 'Jul 2',
        changeOverTime: 0.129924,
      },
      {
        date: '2020-07-06',
        open: 2934.97,
        close: 3057.04,
        high: 3059.88,
        low: 2930,
        volume: 6880642,
        uOpen: 2934.97,
        uClose: 3057.04,
        uHigh: 3059.88,
        uLow: 2930,
        uVolume: 6880642,
        change: 166.74,
        changePercent: 5.769,
        label: 'Jul 6',
        changeOverTime: 0.195109,
      },
      {
        date: '2020-07-07',
        open: 3058.55,
        close: 3000.12,
        high: 3069.55,
        low: 2990,
        volume: 5257514,
        uOpen: 3058.55,
        uClose: 3000.12,
        uHigh: 3069.55,
        uLow: 2990,
        uVolume: 5257514,
        change: -56.92,
        changePercent: -1.8619,
        label: 'Jul 7',
        changeOverTime: 0.172856,
      },
      {
        date: '2020-07-08',
        open: 3022.61,
        close: 3081.11,
        high: 3083.97,
        low: 3012.43,
        volume: 5037635,
        uOpen: 3022.61,
        uClose: 3081.11,
        uHigh: 3083.97,
        uLow: 3012.43,
        uVolume: 5037635,
        change: 80.99,
        changePercent: 2.6996,
        label: 'Jul 8',
        changeOverTime: 0.204518,
      },
      {
        date: '2020-07-09',
        open: 3115.99,
        close: 3182.63,
        high: 3193.88,
        low: 3074,
        volume: 6388659,
        uOpen: 3115.99,
        uClose: 3182.63,
        uHigh: 3193.88,
        uLow: 3074,
        uVolume: 6388659,
        change: 101.52,
        changePercent: 3.2949,
        label: 'Jul 9',
        changeOverTime: 0.244206,
      },
      {
        date: '2020-07-10',
        open: 3191.76,
        close: 3200,
        high: 3215,
        low: 3135.7,
        volume: 5485982,
        uOpen: 3191.76,
        uClose: 3200,
        uHigh: 3215,
        uLow: 3135.7,
        uVolume: 5485982,
        change: 17.37,
        changePercent: 0.5458,
        label: 'Jul 10',
        changeOverTime: 0.250997,
      },
    ],
  },
};

const mockMsftResponse = {
  MSFT: {
    news: [
      {
        datetime: 1594492809000,
        headline:
          "Microsoft's Phil Spencer claims asking studios to make games for Xbox Series X that will also work on Xbox One at launch won't hinder the potential of Series X (Christopher Dring/GamesIndustry.biz)",
        source: 'Techmeme',
        url:
          'https://cloud.iexapis.com/v1/news/article/a2d9ef60-65ba-46a2-926e-e7f1331a8025',
        summary:
          "Christopher Dring / GamesIndustry.biz : Microsoft's Phil Spencer claims asking studios to make games for Xbox Series X that will also work on Xbox One at launch won't hinder the potential of Series X — “Held back is a meme that gets created by people who are too caught up in device competition”",
        related: 'MSFT',
        image:
          'https://cloud.iexapis.com/v1/news/image/a2d9ef60-65ba-46a2-926e-e7f1331a8025',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594490400000,
        headline:
          'Microsoft’s new Windows file recovery: Retrieve deleted documents',
        source: 'TheSouthAfrican',
        url:
          'https://cloud.iexapis.com/v1/news/article/245ab7f0-3a48-4d95-82a0-fa9fa1169869',
        summary:
          "Microsoft rolls out new 'Windows File Recovery' tool to retrieve deleted documents.",
        related: 'MSFT',
        image:
          'https://cloud.iexapis.com/v1/news/image/245ab7f0-3a48-4d95-82a0-fa9fa1169869',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594485710000,
        headline:
          "Bill Gates: Coronavirus treatments should go to those who need them, not 'highest bidder'",
        source: 'The Hill',
        url:
          'https://cloud.iexapis.com/v1/news/article/af4a885e-e8fe-4fdf-a4b8-4b532716fea1',
        summary:
          'Microsoft co-founder and philanthropist Bill Gates said when a COVID-19 vaccine is ready for distribution, it should go to countries that need it the most, not just the "highest bidder."',
        related: 'MSFT',
        image:
          'https://cloud.iexapis.com/v1/news/image/af4a885e-e8fe-4fdf-a4b8-4b532716fea1',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594476405000,
        headline:
          'Health needs not hard cash should determine who gets the coronavirus vaccine first, says Bill Gates',
        source: 'Business Insider',
        url:
          'https://cloud.iexapis.com/v1/news/article/c3da3fa2-02f4-43a9-8a80-f7aedaa3c71f',
        summary:
          'Billionaire Microsoft found Bill Gates spoke at a COVID-19 virtual conference on Saturday. Gates called for the equitable disbursement of coronavirus drugs, so that these drugs don\'t just go to the "highest bidders." The US government bought up almost the entire world\'s stock of remdesivir , a drug that has proved effective in helping patients recover faster from the coronavirus. Visit Business Insider\'s homepage for more stories . Bill Gates said that once a coronavirus vaccine is discovered, it should be distributed fairly and not just go to the "highest bidders." The billionaire Microsoft founder was speaking at a virtual conference on the coronavirus hosted by the International AIDS Society on Saturday. "If we just let drugs and vaccines go to the highest bidders, instead of to the people and the places where they\'re most needed, we\'ll have a longer, more unjust, deadlier pandemic. "We need leaders to make these hard decisions about distributing based on equity, not just on market-driven factors," Gates said.',
        related: 'MSFT',
        image:
          'https://cloud.iexapis.com/v1/news/image/c3da3fa2-02f4-43a9-8a80-f7aedaa3c71f',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594474201000,
        headline: 'The growing fight over police use of facial recognition',
        source: 'CNBC',
        url:
          'https://cloud.iexapis.com/v1/news/article/11b9c59a-b157-478f-a6b5-85d686fd0ee0',
        summary:
          "In light of protests for racial justice, facial recognition has come under scrutiny for how it's used by police, leading to IBM, Amazon, and Microsoft pulling back on this tech.",
        related: 'MSFT',
        image:
          'https://cloud.iexapis.com/v1/news/image/11b9c59a-b157-478f-a6b5-85d686fd0ee0',
        lang: 'en',
        hasPaywall: false,
      },
    ],
    chart: [
      {
        date: '2020-06-11',
        open: 193.13,
        close: 186.27,
        high: 195.76,
        low: 186.07,
        volume: 52854672,
        uOpen: 193.13,
        uClose: 186.27,
        uHigh: 195.76,
        uLow: 186.07,
        uVolume: 52854672,
        change: 0,
        changePercent: 0,
        label: 'Jun 11',
        changeOverTime: 0,
      },
      {
        date: '2020-06-12',
        open: 190.54,
        close: 187.74,
        high: 191.72,
        low: 185.18,
        volume: 43373587,
        uOpen: 190.54,
        uClose: 187.74,
        uHigh: 191.72,
        uLow: 185.18,
        uVolume: 43373587,
        change: 1.47,
        changePercent: 0.7892,
        label: 'Jun 12',
        changeOverTime: 0.007892,
      },
      {
        date: '2020-06-15',
        open: 184.58,
        close: 188.94,
        high: 190.82,
        low: 184.01,
        volume: 32770189,
        uOpen: 184.58,
        uClose: 188.94,
        uHigh: 190.82,
        uLow: 184.01,
        uVolume: 32770189,
        change: 1.2,
        changePercent: 0.6392,
        label: 'Jun 15',
        changeOverTime: 0.014334,
      },
      {
        date: '2020-06-16',
        open: 192.89,
        close: 193.57,
        high: 195.58,
        low: 191.46,
        volume: 42556656,
        uOpen: 192.89,
        uClose: 193.57,
        uHigh: 195.58,
        uLow: 191.46,
        uVolume: 42556656,
        change: 4.63,
        changePercent: 2.4505,
        label: 'Jun 16',
        changeOverTime: 0.03919,
      },
      {
        date: '2020-06-17',
        open: 195.03,
        close: 194.24,
        high: 196.32,
        low: 193.69,
        volume: 25687822,
        uOpen: 195.03,
        uClose: 194.24,
        uHigh: 196.32,
        uLow: 193.69,
        uVolume: 25687822,
        change: 0.67,
        changePercent: 0.3461,
        label: 'Jun 17',
        changeOverTime: 0.042787,
      },
      {
        date: '2020-06-18',
        open: 194,
        close: 196.32,
        high: 196.49,
        low: 194,
        volume: 23061648,
        uOpen: 194,
        uClose: 196.32,
        uHigh: 196.49,
        uLow: 194,
        uVolume: 23061648,
        change: 2.08,
        changePercent: 1.0708,
        label: 'Jun 18',
        changeOverTime: 0.053954,
      },
      {
        date: '2020-06-19',
        open: 198.59,
        close: 195.15,
        high: 199.29,
        low: 194.37,
        volume: 44441141,
        uOpen: 198.59,
        uClose: 195.15,
        uHigh: 199.29,
        uLow: 194.37,
        uVolume: 44441141,
        change: -1.17,
        changePercent: -0.596,
        label: 'Jun 19',
        changeOverTime: 0.047673,
      },
      {
        date: '2020-06-22',
        open: 195.79,
        close: 200.57,
        high: 200.76,
        low: 195.23,
        volume: 32818929,
        uOpen: 195.79,
        uClose: 200.57,
        uHigh: 200.76,
        uLow: 195.23,
        uVolume: 32818929,
        change: 5.42,
        changePercent: 2.7774,
        label: 'Jun 22',
        changeOverTime: 0.07677,
      },
      {
        date: '2020-06-23',
        open: 202.09,
        close: 201.91,
        high: 203.95,
        low: 201.43,
        volume: 30917447,
        uOpen: 202.09,
        uClose: 201.91,
        uHigh: 203.95,
        uLow: 201.43,
        uVolume: 30917447,
        change: 1.34,
        changePercent: 0.6681,
        label: 'Jun 23',
        changeOverTime: 0.083964,
      },
      {
        date: '2020-06-24',
        open: 201.6,
        close: 197.84,
        high: 203.25,
        low: 196.56,
        volume: 36740647,
        uOpen: 201.6,
        uClose: 197.84,
        uHigh: 203.25,
        uLow: 196.56,
        uVolume: 36740647,
        change: -4.07,
        changePercent: -2.0157,
        label: 'Jun 24',
        changeOverTime: 0.062114,
      },
      {
        date: '2020-06-25',
        open: 197.8,
        close: 200.34,
        high: 200.61,
        low: 195.47,
        volume: 27803933,
        uOpen: 197.8,
        uClose: 200.34,
        uHigh: 200.61,
        uLow: 195.47,
        uVolume: 27803933,
        change: 2.5,
        changePercent: 1.2636,
        label: 'Jun 25',
        changeOverTime: 0.075536,
      },
      {
        date: '2020-06-26',
        open: 199.73,
        close: 196.33,
        high: 199.89,
        low: 194.88,
        volume: 54675780,
        uOpen: 199.73,
        uClose: 196.33,
        uHigh: 199.89,
        uLow: 194.88,
        uVolume: 54675780,
        change: -4.01,
        changePercent: -2.0016,
        label: 'Jun 26',
        changeOverTime: 0.054008,
      },
      {
        date: '2020-06-29',
        open: 195.78,
        close: 198.44,
        high: 198.53,
        low: 193.55,
        volume: 26701586,
        uOpen: 195.78,
        uClose: 198.44,
        uHigh: 198.53,
        uLow: 193.55,
        uVolume: 26701586,
        change: 2.11,
        changePercent: 1.0747,
        label: 'Jun 29',
        changeOverTime: 0.065335,
      },
      {
        date: '2020-06-30',
        open: 197.88,
        close: 203.51,
        high: 204.4,
        low: 197.74,
        volume: 34310283,
        uOpen: 197.88,
        uClose: 203.51,
        uHigh: 204.4,
        uLow: 197.74,
        uVolume: 34310283,
        change: 5.07,
        changePercent: 2.5549,
        label: 'Jun 30',
        changeOverTime: 0.092554,
      },
      {
        date: '2020-07-01',
        open: 203.14,
        close: 204.7,
        high: 206.35,
        low: 201.77,
        volume: 32061206,
        uOpen: 203.14,
        uClose: 204.7,
        uHigh: 206.35,
        uLow: 201.77,
        uVolume: 32061206,
        change: 1.19,
        changePercent: 0.5847,
        label: 'Jul 1',
        changeOverTime: 0.098942,
      },
      {
        date: '2020-07-02',
        open: 205.68,
        close: 206.26,
        high: 208.02,
        low: 205,
        volume: 29315762,
        uOpen: 205.68,
        uClose: 206.26,
        uHigh: 208.02,
        uLow: 205,
        uVolume: 29315762,
        change: 1.56,
        changePercent: 0.7621,
        label: 'Jul 2',
        changeOverTime: 0.107317,
      },
      {
        date: '2020-07-06',
        open: 208.83,
        close: 210.7,
        high: 211.13,
        low: 208.09,
        volume: 31897629,
        uOpen: 208.83,
        uClose: 210.7,
        uHigh: 211.13,
        uLow: 208.09,
        uVolume: 31897629,
        change: 4.44,
        changePercent: 2.1526,
        label: 'Jul 6',
        changeOverTime: 0.131154,
      },
      {
        date: '2020-07-07',
        open: 210.45,
        close: 208.25,
        high: 214.67,
        low: 207.99,
        volume: 33600732,
        uOpen: 210.45,
        uClose: 208.25,
        uHigh: 214.67,
        uLow: 207.99,
        uVolume: 33600732,
        change: -2.45,
        changePercent: -1.1628,
        label: 'Jul 7',
        changeOverTime: 0.118001,
      },
      {
        date: '2020-07-08',
        open: 210.07,
        close: 212.83,
        high: 213.26,
        low: 208.69,
        volume: 33600025,
        uOpen: 210.07,
        uClose: 212.83,
        uHigh: 213.26,
        uLow: 208.69,
        uVolume: 33600025,
        change: 4.58,
        changePercent: 2.1993,
        label: 'Jul 8',
        changeOverTime: 0.142589,
      },
      {
        date: '2020-07-09',
        open: 216.33,
        close: 214.32,
        high: 216.38,
        low: 211.47,
        volume: 33121681,
        uOpen: 216.33,
        uClose: 214.32,
        uHigh: 216.38,
        uLow: 211.47,
        uVolume: 33121681,
        change: 1.49,
        changePercent: 0.7001,
        label: 'Jul 9',
        changeOverTime: 0.150588,
      },
      {
        date: '2020-07-10',
        open: 213.62,
        close: 213.67,
        high: 214.08,
        low: 211.08,
        volume: 26177633,
        uOpen: 213.62,
        uClose: 213.67,
        uHigh: 214.08,
        uLow: 211.08,
        uVolume: 26177633,
        change: -0.65,
        changePercent: -0.3033,
        label: 'Jul 10',
        changeOverTime: 0.147098,
      },
    ],
    quote: {
      symbol: 'MSFT',
      companyName: 'Microsoft Corp.',
      primaryExchange: 'NASDAQ',
      calculationPrice: 'close',
      open: 213.42,
      openTime: 1594387800846,
      openSource: 'official',
      close: 213.67,
      closeTime: 1594411200285,
      closeSource: 'official',
      high: 214.08,
      highTime: 1594425594088,
      highSource: '15 minute delayed price',
      low: 211.08,
      lowTime: 1594389852339,
      lowSource: '15 minute delayed price',
      latestPrice: 213.67,
      latestSource: 'Close',
      latestTime: 'July 10, 2020',
      latestUpdate: 1594411200285,
      latestVolume: 26177633,
      iexRealtimePrice: null,
      iexRealtimeSize: null,
      iexLastUpdated: null,
      delayedPrice: 214.24,
      delayedPriceTime: 1594425594088,
      oddLotDelayedPrice: 213.72,
      oddLotDelayedPriceTime: 1594411200009,
      extendedPrice: 214.24,
      extendedChange: 0.57,
      extendedChangePercent: 0.00267,
      extendedPriceTime: 1594425594088,
      previousClose: 214.32,
      previousVolume: 33121681,
      change: -0.65,
      changePercent: -0.00303,
      volume: 26177633,
      iexMarketPercent: null,
      iexVolume: null,
      avgTotalVolume: 34231114,
      iexBidPrice: null,
      iexBidSize: null,
      iexAskPrice: null,
      iexAskSize: null,
      iexOpen: null,
      iexOpenTime: null,
      iexClose: 213.83,
      iexCloseTime: 1594411196278,
      marketCap: 1620353624800,
      peRatio: 35.24,
      week52High: 216.38,
      week52Low: 130.78,
      ytdChange: 0.327253,
      lastTradeTime: 1594411200284,
      isUSMarketOpen: false,
    },
  },
};

const mockCostResponse = {
  COST: {
    news: [
      {
        datetime: 1594407489000,
        headline:
          'Costco Didn’t Enforce Its Dress Code — Until Employees Started Wearing Black Lives Matter Masks',
        source: 'BuzzFeed News',
        url:
          'https://cloud.iexapis.com/v1/news/article/0bdf39c7-11b8-49ac-96dd-27f1119dab04',
        summary:
          "The retail giant's policies require workers to look “professional,” but employees say managers ignored it until some employees started wearing masks that Costco calls “political.”",
        related: 'COST',
        image:
          'https://cloud.iexapis.com/v1/news/image/0bdf39c7-11b8-49ac-96dd-27f1119dab04',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594404164000,
        headline: 'Costco opening times update across Scotland',
        source: 'Herald Scotland',
        url:
          'https://cloud.iexapis.com/v1/news/article/d7fc55e6-6659-4e9f-bcbe-77ad443dd479',
        summary:
          'Costco has announced changes to their opening times in Scotland.',
        related: 'COST',
        image:
          'https://cloud.iexapis.com/v1/news/image/d7fc55e6-6659-4e9f-bcbe-77ad443dd479',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594402699000,
        headline:
          "Illinois Costco shopper spits in man's face for removing mask while exiting store: police",
        source: 'Fox News',
        url:
          'https://cloud.iexapis.com/v1/news/article/e54a6f76-f3e4-4be5-af18-a5fc5440607a',
        summary:
          'A woman who claimed to be a teacher assaulted a man and spit in his face when he took his mask off while exiting a Costco store.',
        related: 'COST',
        image:
          'https://cloud.iexapis.com/v1/news/image/e54a6f76-f3e4-4be5-af18-a5fc5440607a',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594375213000,
        headline:
          'This startup sells clothes from the same factories as Alexander Wang and Prada—at a fraction of the cost',
        source: 'Fast Company',
        url:
          'https://cloud.iexapis.com/v1/news/article/c57940a0-ad2d-48a0-8ec4-acb946dd38c7',
        summary:
          'It’s Costco but for cashmere sweaters, leather jackets, and high-end cookware. Last year, Alexander Wang sent a model down the runway at New York Fashion Week in a leather biker jacket that cost $2,995 . A startup called Italic found the same factory that Wang used and created a similar jacket—including the placement of studs, zippers, and a belted waist—that was distinct enough that it wasn’t considered cribbing the design. Italic’s price? $280 . Read Full Story',
        related: 'COST',
        image:
          'https://cloud.iexapis.com/v1/news/image/c57940a0-ad2d-48a0-8ec4-acb946dd38c7',
        lang: 'en',
        hasPaywall: false,
      },
      {
        datetime: 1594334372000,
        headline: 'Walgreens, Bed Bath & Beyond fall; Costco, SAP rise',
        source: 'ABC News',
        url:
          'https://cloud.iexapis.com/v1/news/article/8039de56-385a-4334-be96-4b2d1b617ae8',
        summary:
          'Stocks that moved heavily or traded substantially on Thursday: Walgreens, Bed Bath & Beyond fall; Costco, SAP rise',
        related: 'COST',
        image:
          'https://cloud.iexapis.com/v1/news/image/8039de56-385a-4334-be96-4b2d1b617ae8',
        lang: 'en',
        hasPaywall: false,
      },
    ],
    chart: [
      {
        date: '2020-06-11',
        open: 306.99,
        close: 300.83,
        high: 309.2,
        low: 300.64,
        volume: 3443012,
        uOpen: 306.99,
        uClose: 300.83,
        uHigh: 309.2,
        uLow: 300.64,
        uVolume: 3443012,
        change: 0,
        changePercent: 0,
        label: 'Jun 11',
        changeOverTime: 0,
      },
      {
        date: '2020-06-12',
        open: 302.67,
        close: 298.7,
        high: 305.15,
        low: 296.25,
        volume: 4020006,
        uOpen: 302.67,
        uClose: 298.7,
        uHigh: 305.15,
        uLow: 296.25,
        uVolume: 4020006,
        change: -2.13,
        changePercent: -0.708,
        label: 'Jun 12',
        changeOverTime: -0.00708,
      },
      {
        date: '2020-06-15',
        open: 297.05,
        close: 297.18,
        high: 298.07,
        low: 293.84,
        volume: 3273164,
        uOpen: 297.05,
        uClose: 297.18,
        uHigh: 298.07,
        uLow: 293.84,
        uVolume: 3273164,
        change: -1.52,
        changePercent: -0.5089,
        label: 'Jun 15',
        changeOverTime: -0.012133,
      },
      {
        date: '2020-06-16',
        open: 301.35,
        close: 301.36,
        high: 302.74,
        low: 299.22,
        volume: 2641785,
        uOpen: 301.35,
        uClose: 301.36,
        uHigh: 302.74,
        uLow: 299.22,
        uVolume: 2641785,
        change: 4.18,
        changePercent: 1.4066,
        label: 'Jun 16',
        changeOverTime: 0.001762,
      },
      {
        date: '2020-06-17',
        open: 301.02,
        close: 299.61,
        high: 302,
        low: 298.9,
        volume: 2188401,
        uOpen: 301.02,
        uClose: 299.61,
        uHigh: 302,
        uLow: 298.9,
        uVolume: 2188401,
        change: -1.75,
        changePercent: -0.5807,
        label: 'Jun 17',
        changeOverTime: -0.004055,
      },
      {
        date: '2020-06-18',
        open: 300,
        close: 299.57,
        high: 300.81,
        low: 297.79,
        volume: 1881774,
        uOpen: 300,
        uClose: 299.57,
        uHigh: 300.81,
        uLow: 297.79,
        uVolume: 1881774,
        change: -0.04,
        changePercent: -0.0134,
        label: 'Jun 18',
        changeOverTime: -0.004188,
      },
      {
        date: '2020-06-19',
        open: 300.18,
        close: 299.9,
        high: 301.9,
        low: 298.64,
        volume: 3432670,
        uOpen: 300.18,
        uClose: 299.9,
        uHigh: 301.9,
        uLow: 298.64,
        uVolume: 3432670,
        change: 0.33,
        changePercent: 0.1102,
        label: 'Jun 19',
        changeOverTime: -0.003091,
      },
      {
        date: '2020-06-22',
        open: 299.7,
        close: 300.45,
        high: 301.48,
        low: 298.25,
        volume: 2094436,
        uOpen: 299.7,
        uClose: 300.45,
        uHigh: 301.48,
        uLow: 298.25,
        uVolume: 2094436,
        change: 0.55,
        changePercent: 0.1834,
        label: 'Jun 22',
        changeOverTime: -0.001263,
      },
      {
        date: '2020-06-23',
        open: 301.73,
        close: 301.29,
        high: 304.9,
        low: 300.73,
        volume: 2409639,
        uOpen: 301.73,
        uClose: 301.29,
        uHigh: 304.9,
        uLow: 300.73,
        uVolume: 2409639,
        change: 0.84,
        changePercent: 0.2796,
        label: 'Jun 23',
        changeOverTime: 0.001529,
      },
      {
        date: '2020-06-24',
        open: 300.77,
        close: 298.02,
        high: 301.28,
        low: 296.6,
        volume: 2398089,
        uOpen: 300.77,
        uClose: 298.02,
        uHigh: 301.28,
        uLow: 296.6,
        uVolume: 2398089,
        change: -3.27,
        changePercent: -1.0853,
        label: 'Jun 24',
        changeOverTime: -0.009341,
      },
      {
        date: '2020-06-25',
        open: 297.06,
        close: 300.53,
        high: 301.15,
        low: 295.4,
        volume: 2274283,
        uOpen: 297.06,
        uClose: 300.53,
        uHigh: 301.15,
        uLow: 295.4,
        uVolume: 2274283,
        change: 2.51,
        changePercent: 0.8422,
        label: 'Jun 25',
        changeOverTime: -0.000997,
      },
      {
        date: '2020-06-26',
        open: 300.41,
        close: 296.56,
        high: 302.12,
        low: 295.95,
        volume: 2865999,
        uOpen: 300.41,
        uClose: 296.56,
        uHigh: 302.12,
        uLow: 295.95,
        uVolume: 2865999,
        change: -3.97,
        changePercent: -1.321,
        label: 'Jun 26',
        changeOverTime: -0.014194,
      },
      {
        date: '2020-06-29',
        open: 297.44,
        close: 301.59,
        high: 301.63,
        low: 296.83,
        volume: 1841733,
        uOpen: 297.44,
        uClose: 301.59,
        uHigh: 301.63,
        uLow: 296.83,
        uVolume: 1841733,
        change: 5.03,
        changePercent: 1.6961,
        label: 'Jun 29',
        changeOverTime: 0.002526,
      },
      {
        date: '2020-06-30',
        open: 301.01,
        close: 303.21,
        high: 304.62,
        low: 300.14,
        volume: 2392034,
        uOpen: 301.01,
        uClose: 303.21,
        uHigh: 304.62,
        uLow: 300.14,
        uVolume: 2392034,
        change: 1.62,
        changePercent: 0.5372,
        label: 'Jun 30',
        changeOverTime: 0.007911,
      },
      {
        date: '2020-07-01',
        open: 302.5,
        close: 304.75,
        high: 305.58,
        low: 300.75,
        volume: 1906372,
        uOpen: 302.5,
        uClose: 304.75,
        uHigh: 305.58,
        uLow: 300.75,
        uVolume: 1906372,
        change: 1.54,
        changePercent: 0.5079,
        label: 'Jul 1',
        changeOverTime: 0.013031,
      },
      {
        date: '2020-07-02',
        open: 306,
        close: 305.74,
        high: 308.92,
        low: 304.6,
        volume: 2540480,
        uOpen: 306,
        uClose: 305.74,
        uHigh: 308.92,
        uLow: 304.6,
        uVolume: 2540480,
        change: 0.99,
        changePercent: 0.3249,
        label: 'Jul 2',
        changeOverTime: 0.016322,
      },
      {
        date: '2020-07-06',
        open: 307.53,
        close: 311.49,
        high: 311.56,
        low: 307.24,
        volume: 2332442,
        uOpen: 307.53,
        uClose: 311.49,
        uHigh: 311.56,
        uLow: 307.24,
        uVolume: 2332442,
        change: 5.75,
        changePercent: 1.8807,
        label: 'Jul 6',
        changeOverTime: 0.035435,
      },
      {
        date: '2020-07-07',
        open: 310.02,
        close: 316.23,
        high: 318.05,
        low: 309.72,
        volume: 3346634,
        uOpen: 310.02,
        uClose: 316.23,
        uHigh: 318.05,
        uLow: 309.72,
        uVolume: 3346634,
        change: 4.74,
        changePercent: 1.5217,
        label: 'Jul 7',
        changeOverTime: 0.051192,
      },
      {
        date: '2020-07-08',
        open: 317.14,
        close: 316.32,
        high: 318.05,
        low: 314.01,
        volume: 2364495,
        uOpen: 317.14,
        uClose: 316.32,
        uHigh: 318.05,
        uLow: 314.01,
        uVolume: 2364495,
        change: 0.09,
        changePercent: 0.0285,
        label: 'Jul 8',
        changeOverTime: 0.051491,
      },
      {
        date: '2020-07-09',
        open: 320,
        close: 325.54,
        high: 328.98,
        low: 319.68,
        volume: 5313636,
        uOpen: 320,
        uClose: 325.54,
        uHigh: 328.98,
        uLow: 319.68,
        uVolume: 5313636,
        change: 9.22,
        changePercent: 2.9148,
        label: 'Jul 9',
        changeOverTime: 0.082139,
      },
      {
        date: '2020-07-10',
        open: 326,
        close: 326.23,
        high: 327.4,
        low: 323.11,
        volume: 2484088,
        uOpen: 326,
        uClose: 326.23,
        uHigh: 327.4,
        uLow: 323.11,
        uVolume: 2484088,
        change: 0.69,
        changePercent: 0.212,
        label: 'Jul 10',
        changeOverTime: 0.084433,
      },
    ],
    quote: {
      symbol: 'COST',
      companyName: 'Costco Wholesale Corp.',
      primaryExchange: 'NASDAQ',
      calculationPrice: 'close',
      open: 325.6,
      openTime: 1594387801468,
      openSource: 'official',
      close: 326.23,
      closeTime: 1594411200497,
      closeSource: 'official',
      high: 327.4,
      highTime: 1594425315853,
      highSource: '15 minute delayed price',
      low: 323.11,
      lowTime: 1594388741833,
      lowSource: '15 minute delayed price',
      latestPrice: 326.23,
      latestSource: 'Close',
      latestTime: 'July 10, 2020',
      latestUpdate: 1594411200497,
      latestVolume: 2484088,
      iexRealtimePrice: null,
      iexRealtimeSize: null,
      iexLastUpdated: null,
      delayedPrice: 326.25,
      delayedPriceTime: 1594425315853,
      oddLotDelayedPrice: 326,
      oddLotDelayedPriceTime: 1594411199550,
      extendedPrice: 326.25,
      extendedChange: 0.02,
      extendedChangePercent: 0.00006,
      extendedPriceTime: 1594425315853,
      previousClose: 325.54,
      previousVolume: 5313636,
      change: 0.69,
      changePercent: 0.00212,
      volume: 2484088,
      iexMarketPercent: null,
      iexVolume: null,
      avgTotalVolume: 2932848,
      iexBidPrice: null,
      iexBidSize: null,
      iexAskPrice: null,
      iexAskSize: null,
      iexOpen: null,
      iexOpenTime: null,
      iexClose: 326.24,
      iexCloseTime: 1594411197116,
      marketCap: 144038374520,
      peRatio: 38.81,
      week52High: 328.98,
      week52Low: 262.71,
      ytdChange: 0.12130099999999999,
      lastTradeTime: 1594411200497,
      isUSMarketOpen: false,
    },
  },
};

describe('test stock-api lambda', async () => {
  beforeEach(() => {
    nock.cleanAll();
  });
  it('should return msft data with msft in path', async () => {
    nock('https://cloud.iexapis.com')
      .get(
        `/stable/stock/market/batch?symbols=msft&types=quote,news,chart&range=1m&last=5&token=${iexApiKey}`
      )
      .reply(200, mockMsftResponse);
    const response = await getStock(mockPathEvent);
    expect(response.statusCode).to.equal(200);
  });
  it('should return amzn data with a blank call', async () => {
    nock('https://cloud.iexapis.com')
      .get(
        `/stable/stock/market/batch?symbols=amzn&types=quote,news,chart&range=1m&last=5&token=${iexApiKey}`
      )
      .reply(200, mockAmznResponse);
    const response = await getStock(mockBlankEvent);
    expect(response.statusCode).to.equal(200);
  });
  it('should return amzn data with query string parameters', async () => {
    nock('https://cloud.iexapis.com')
      .get(
        `/stable/stock/market/batch?symbols=cost&types=quote,news,chart&range=1m&last=5&token=${iexApiKey}`
      )
      .reply(200, mockCostResponse);
    const response = await getStock(mockQueryStringParameters);
    expect(response.statusCode).to.equal(200);
  });
  it('should test iex error', async () => {
    nock('https://cloud.iexapis.com')
      .get(
        `/stable/stock/market/batch?symbols=amzn&types=quote,news,chart&range=1m&last=5&token=${iexApiKey}`
      )
      .reply(404, {
        message: 'IEX Error',
      });
    const response = await getStock(mockBlankEvent);
    expect(response.statusCode).to.equal(404);
    expect(JSON.parse(response.body).message).to.equal('IEX Error');
  });
});
